name: Predict Daily FX Direction (09â†’13)

on:
  workflow_dispatch: {}
  schedule:
    - cron: "55 7 * * 1-5"   # ~08:55 London when UK is UTC+1; adjust as desired

permissions:
  contents: read
  actions: read

jobs:
  predict:
    runs-on: ubuntu-latest
    env:
      GOOGLE_SERVICE_ACCOUNT_JSON: ${{ secrets.GOOGLE_SERVICE_ACCOUNT_JSON }}
      TF_CPP_MIN_LOG_LEVEL: "2"
      PYTHONUNBUFFERED: "1"

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with: { python-version: "3.11" }

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Export FX_TICKERS
        env: { FX_TICKERS: ${{ vars.FX_TICKERS || secrets.FX_TICKERS }} }
        run: |
          echo "FX_TICKERS=${FX_TICKERS}" >> $GITHUB_ENV
          echo "Using pairs: ${FX_TICKERS:-EURUSD=X,GBPUSD=X,USDJPY=X}"

      # Download latest trained model artifact
      - name: Download model from latest successful Train run
        env: { GH_TOKEN: ${{ secrets.GITHUB_TOKEN }} }
        run: |
          RUN_ID=$(gh run list \
            --workflow "Train FX CNN-LSTM" \
            --branch main \
            --json databaseId,conclusion,status \
            -q '[.[] | select(.conclusion=="success" and .status=="completed")][0].databaseId')
          if [ -z "$RUN_ID" ]; then echo "Run Train first"; exit 1; fi
          mkdir -p _train_artifact
          gh run download "$RUN_ID" --name "model-and-artifacts" --dir _train_artifact
          mkdir -p models artifacts
          rsync -a _train_artifact/models/ models/ || true
          rsync -a _train_artifact/artifacts/ artifacts/ || true
          ls -la models || true

      - name: Run predict
        run: |
          python -X faulthandler -m src.predict_daily 2>&1 | tee -a artifacts/predict_log.txt

      - name: Upload predict artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: predict-artifacts
          path: artifacts/
